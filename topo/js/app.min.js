function addModel(a){var b,c,d,e,f,g,h,i,j;for($("#modelDialog").remove(),b=$("<div id='modelDialog' style='height:0px;'></div>").hide().html("<div id='modelDialogTitle'>模型库</div><div id='modelDialogClose'>X&nbsp;</div><div id='modelDiv'></div>"),$("body").append(b),c=$("#modelDialog"),dragDom("modelDialogTitle","modelDialog"),$("#modelDialogClose").on("click",function(){c.animate({height:0,opacity:.1,top:"10%"},1e3,function(){$(this).hide()})}),d=$("#modelDialog").height()-$("#modelDialogTitle").height(),e=$("#modelDiv"),e.css({height:d,"margin-top":$("#modelDialogTitle").height()}),e.html(""),f=0;f<a.length;f++){if(g=$("<div class='iconTitle'><div class='title'>"+a[f].title+"</div>"+"<div class='img'></div></div>"),h=$("<div class='iconConten' title='"+a[f].title+"'></div>"),a[f].icon)for(i=0;i<a[f].icon.length;i++)j=$("<div class='icon' ></div>"),j.css({width:"60px",height:"60px",cursor:"move","background-image":"url(image/nodeImg/"+a[f].icon[i].modelImg+")","background-size":"100% 100%","float":"left"}),j.attr({title:""+a[f].icon[i].title,name:""+a[f].icon[i].modelImg,id:"drag_node_"+i}),h.append(j);e.append(g,h)}g=$(".iconTitle"),g.on("click",function(){var a=$(this).find(".title").html();$(".iconConten").fadeOut(500),$(".iconConten[title='"+a+"']").fadeIn(500)}),g.first().click(),$(".icon").bind("mousedown",function(){var b=$(this),c=b.attr("name"),d=b.clone(!0);$("body").append(d),d.hide(),$(document).mousemove(function(a){d.show(),d.css({"z-index":100,position:"absolute",left:a.clientX-d.width()/2,top:a.clientY-d.height()/2})}),$(document).mouseup(function(){var b,e,f,g,h,i,j,k;if(d.show(),$(document).unbind("mousemove"),$(document).unbind("mouseup"),"业务系统"==d.attr("title"))for(b=$("#nav").height(),e=new JTopo.Container,e.setLocation(parseInt(d.position().left),parseInt(d.position().top-b)),e.zIndex=11,e.borderWidth=5,e.textOffsetY=0,e.textOffsetX=0,e.borderRadius=0,e.alpha=1,e.text=d.attr("title"),e.font="18px Microsoft YaHei",e.fontColor="255,255,255",e.fillColor="10,10,100",e.borderColor="255,0,0",e.textPosition="Bottom_Center",e.dragable=!0,e.childNodes="",scene.add(e),d.remove(),f=0;2>f;f++)g=new JTopo.Node,g.title="拉抻节点",g.textPosition="Middle_Center",g.setBound(e.x+200*f,e.y+200*f,10,10),g.zIndex=13,scene.add(g),e.add(g);else for(h=d.width(),i=d.height(),b=$("#nav").height(),g=new JTopo.Node,g.setBound(d.position().left,d.position().top-b,h,i),g.zIndex=13,g.borderWidth=0,g.borderRadius=30,g.textOffsetY=0,g.textOffsetX=0,g.alpha=1,g.text=d.attr("title"),g.font="18px Microsoft YaHei",g.fontColor="255,255,255",g.setImage("image/nodeImg/"+c),g.dragable=!0,g.textPosition="Bottom_Center",g.borderColor="255,0,0",g.fillColor="0,255,0",g.alarmValue="",g.ip="",g.geographic="",g.firm="",g.agent="是",g.port="",g.userName="",g.passWord="",g.info="",scene.add(g),d.remove(),j=scene.childs,f=j.length-1;f>=0;f--)k=j[f],"container"==k.elementType&&g.x>k.x&&g.x<k.x+k.width&&g.y>k.y&&g.y<k.y+k.height&&(k.add(g),g.containerText=k.text);initRightButton()})})}function openLink(a,b){line=null,scene.removeEventListener("mouseup"),scene.removeEventListener("mousedown"),scene.removeEventListener("mousemove"),scene.mouseup(function(c){2==c.button&&(fNode=null,line&&(scene.remove(line),line=null));var d=scene.childs;if(d.length,null!=c.target&&c.target instanceof JTopo.Node)if(fNode)line&&("背景"==c.target.info||void 0==c.target.text||"undefined"==c.target.text?(scene.remove(line),line=null):(line.nodeZ=c.target,line=null)),fNode=null;else if(fNode=c.target,"背景"==fNode.info);else{if(tempNode.setLocation(c.x,c.y),"link"==a||"直线"==b)line=new JTopo.Link(fNode,tempNode),line.offsetGap=0,line.arrowsRadius=0,line.bundleOffset=0,line.dashedPattern=null,"虚直线"==b?line.dashedPattern=10:"直线带箭头"==b?line.arrowsRadius=15:"虚直线箭头"==b&&(line.dashedPattern=10,line.arrowsRadius=15),line.bundleOffset=20;else if("foldLink"==a||"折线"==b)line=new JTopo.FoldLink(fNode,tempNode),line.offsetGap=0,line.arrowsRadius=0,line.bundleOffset=0,line.dashedPattern=null,"虚折线"==b?line.dashedPattern=10:"折线带箭头"==b?line.arrowsRadius=15:"虚折线箭头"==b&&(line.dashedPattern=10,line.arrowsRadius=15),line.bundleOffset=20;else if("flexionalLink"==a||"二次折线"==b)line=new JTopo.FlexionalLink(fNode,tempNode),line.offsetGap=0,line.arrowsRadius=0,line.bundleOffset=0,line.dashedPattern=null,"虚二次折线"==b?line.dashedPattern=10:"二次折线带箭头"==b?line.arrowsRadius=15:"虚二次折线箭头"==b&&(line.dashedPattern=10,line.arrowsRadius=15),line.offsetGap=40;else if("stopLink"==a)return fNode=null,scene.removeEventListener("mouseup"),scene.removeEventListener("mousedown"),scene.removeEventListener("mousemove"),void 0;line.zIndex=12,line.lineWidth=3,line.bundleGap=0,line.textOffsetY=0,line.textOffsetX=0,line.alpha=1,line.font="18px Microsoft YaHei",line.text="未定义",line.fontColor="255,255,255",line.linkClass=b,line.strokeColor=JTopo.util.randomColor(),line.alarmValue="",line.ip="0",line.geographic="",line.firm="",line.info="",line.agent="是",line.port="",line.userName="",line.passWord="",scene.add(line),initRightButton()}else fNode=null,line&&scene.remove(line),line=null}),scene.mousemove(function(a){tempNode.setLocation(a.x,a.y)})}function addJtopoMenu(){$("#operateDialog").remove();var a=$("<div id='operateDialog' style='height:0px;'></div>").hide().html("<div id='operateDialogTitle'>拓扑操作</div><div id='operateDialogClose'>X&nbsp;</div><div id='operateDiv'></div>");$("body").append(a),$("#operateDialogClose").on("click",function(){$("#operateDialog").animate({height:0,opacity:.1,top:"10%"},1e3,function(){$(this).hide()})}),dragDom("operateDialogTitle","operateDialog"),$("#operateDiv").html('<label>业务系统：<select id="getBsName"><option>网银系统</option></select></label></br><label>拓扑名称：<input type="text" name="topoName" id="topoName"/></label></br><div class="straight"><div class="straightLine" title="直线" name="link"></div><div class="straightLineArrow" title="虚直线" name="link"></div><div class="virtualStraightLine" title="直线带箭头" name="link"></div><div class="virtualStraightLineArrow" title="虚直线箭头" name="link"></div></div><div class="broken"><div class="brokenLine" title="折线" name="foldLink"></div><div class="brokenLineArrow" title="虚折线" name="foldLink"></div><div class="virtualBrokenLine" title="折线带箭头" name="foldLink"></div><div class="virtualBrokenLineArrow" title="虚折线箭头" name="foldLink"></div></div><div class="twoBroken"><div class="twoBrokenLine" title="二次折线" name="flexionalLink"></div><div class="twoBrokenLineArrow" title="虚二次折线" name="flexionalLink"></div><div class="virtualTwoBrokenLine" title="二次折线带箭头" name="flexionalLink"></div><div class="virtualTwoBrokenLineArrow" title="虚二次折线箭头" name="flexionalLink"></div></div><div title="停止连线" id="stopLink" class="stopLink" name="stopLink" ></div><br /><div id="savaDragTopo" title="保存" ></div><div id="clear" title="清除全部" ></div>'),$("#operateDiv").find("div").on("click",function(){var b=$(this).attr("name"),c=$(this).attr("title");"link"==b||"foldLink"==b||"flexionalLink"==b?(openLink(b,c),$(this).width()<51&&($("#operateDiv").find("div").removeClass("opms"),$(this).addClass("opms"),$("#stopLink").removeClass("stopLink").addClass("opmsStop"))):"停止连线"==c?($("#operateDiv").find("div").removeClass("opms"),$("#stopLink").removeClass("opmsStop").addClass("stopLink"),fNode=null,scene.removeEventListener("mouseup"),scene.removeEventListener("mousedown"),scene.removeEventListener("mousemove")):"保存"==c?serializeJson(c):"清除全部"==c&&($("#stopLink").click(),$("#showFunc").is(":hidden")?alert("错误信息！"):scene.clear())})}function serializeJson(method){var nodeJson,linkJson,containerJson,i,node,subNodeImage,nodeImage,childsNode,cn,reg,data,size=0,k=scene.childs;if(0==k.length)return $("#stopLink").click(),$("#dialog,#full").remove(),alert("没有节点！"),!1;if(sb="{",""==$("#operateTopo input[name=bsName]").val())return alert("业务系统名称未设置！"),!1;for(sb+='"bsName":"'+$("#getBsName").find("option:selected").val()+'",',sb+='"topoSceneName":"'+$("#topoName").val()+'",',nodeJson='"node":[',linkJson='"link":[',containerJson='"container":[',i=k.length-1;i>=0;i--)if(node=k[i],void 0!=node){subNodeImage="";try{nodeImage=node["image"]&&node["image"]["src"],void 0!=nodeImage?(subNodeImage=nodeImage.substr(nodeImage.lastIndexOf("image"),nodeImage.length),subNodeImage=subNodeImage.substring(14)):subNodeImage=""}catch(e){subNodeImage=""}if("node"==node.elementType||"TextNode"==node.elementType)"拉抻节点"==node.title?console.log("拉伸节点不保存"+i):(nodeJson=nodeJson+'{"x":'+node.x+',"y":'+node.y+',"width":'+node.width+',"height":'+node.height+',"mapId":'+node._id+',"zIndex":'+node.zIndex+',"borderWidth":'+node.borderWidth+',"borderRadius":'+node.borderRadius+',"textOffsetY":'+node.textOffsetY+',"textOffsetX":'+node.textOffsetX+',"alpha":'+node.alpha+',"nodeType":"'+node.elementType+'","font":"'+node.font+'","text":"'+node.text+'","fontColor":"'+node.fontColor+'","nodeImg":"'+subNodeImage+'","dragable":"'+node.dragable+'","textPosition":"'+node.textPosition+'","borderColor":"'+node.borderColor+'","fillColor":"'+node.fillColor+'","alarmValue":"'+node.alarmValue+'","ip":"'+node.ip+'","geographic":"'+node.geographic+'","firm":"'+node.firm+'","agent":"'+node.agent+'","port":"'+node.port+'","userName":"'+node.userName+'","passWord":"'+node.passWord+'","info":"'+node.info+'"}',0!=i&&(nodeJson+=","));else if("link"==node.elementType)null!=node.nodeA&&null!=node.nodeZ&&(linkJson=linkJson+'{"bundleOffset":'+node.bundleOffset+',"zIndex":'+node.zIndex+',"lineWidth":'+node.lineWidth+',"bundleGap":'+node.bundleGap+',"offsetGap":'+node.offsetGap+',"textOffsetY":'+node.textOffsetY+',"textOffsetX":'+node.textOffsetX+',"alpha":'+node.alpha+',"arrowsRadius":'+node.arrowsRadius+',"dashedPattern":'+node.dashedPattern+',"nodeType":"'+node.elementType+'","font":"'+node.font+'","text":"'+node.text+'","fontColor":"'+node.fontColor+'","linkClass":"'+node.linkClass+'","strokeColor":"'+node.strokeColor+'","alarmValue":"'+'","fromNodeIp":"'+node.nodeA.ip+'","toNodeIp":"'+node.nodeZ.ip+'","fromNodeMapId":"'+node.nodeA._id+'","toNodeMapId":"'+node.nodeZ._id+'","ip":"'+node.ip+'","geographic":"'+node.geographic+'","firm":"'+node.firm+'","agent":"'+node.agent+'","port":"'+node.port+'","userName":"'+node.userName+'","passWord":"'+node.passWord+'","info":"'+node.info+'"}',0!=i&&(linkJson+=","));else if("container"==node.elementType){for(childsNode=new Array,cn=0;cn<node.childs.length;cn++)"拉抻节点"==node.childs[cn].title?console.log("拉伸节点不保存"+cn):childsNode.push('"'+node.childs[cn]._id+'"');containerJson=containerJson+'{"nodeType":"'+node.elementType+'","text":"'+node.text+'","width":"'+node.width+'","zIndex":'+node.zIndex+',"alpha":'+node.alpha+',"textPosition":"'+node.textPosition+'","dragable":"'+node.dragable+'","textOffsetY":'+node.textOffsetY+',"font":"'+node.font+'","fontColor":"'+node.fontColor+'","fillColor":"'+node.fillColor+'","borderColor":"'+node.borderColor+'","borderWidth":'+node.borderWidth+',"x":'+node.x+',"y":'+node.y+',"height":'+node.height+',"layout":"网格布局"'+',"borderRadius":'+node.borderRadius+',"childs":['+childsNode+"]}",0!=i&&(containerJson+=",")}}reg=/,$/gi,nodeJson=nodeJson.replace(reg,""),linkJson=linkJson.replace(reg,""),containerJson=containerJson.replace(reg,""),sb=sb+nodeJson+"],"+linkJson+"],"+containerJson+"]}","修改"==method||(console.log(sb),$("#stopLink").click(),data=eval("("+sb+")"),$.topo.newScene(scene,data),$("#showFunc,#showModel").hide(),$("#modelDialog,#operateDialog").remove(),initRightButton())}function handler(a){var c,d,b=$("#contextmenu");2==a.button?($("#stopLink").click(),c=$(document).height(),d=c-(a.pageY+20),b.css({top:a.pageY-10,left:a.pageX-10,height:d+"px"}).show(),b.height()<150&&b.css({top:a.pageY-160,left:a.pageX-10,height:d+150}),b.find("li a").show(),"node"==currentNode.elementType&&b.show()):b.hide(),$("#XAlign").unbind("click").click(function(){var b,a=scene.selectedElements;if("container"==currentNode.elementType)for(b=0;b<a.length;b++)void 0==a[b].childs?alert("设备不能和业务系统对齐"):(a[b].childs[0].x=currentNode.childs[0].x,a[b].childs[1].x=currentNode.childs[1].x);else for(b=0;b<a.length;b++)a[b].childs?alert("设备不能和业务系统对齐"):a[b].x=currentNode.x;return scene.removeAllEventListener(),!1}),$("#YAlign").unbind("click").click(function(){var b,a=scene.selectedElements;if("container"==currentNode.elementType)for(b=0;b<a.length;b++)void 0==a[b].childs?alert("设备不能和业务系统对齐"):(a[b].childs[0].y=currentNode.childs[0].y,a[b].childs[1].y=currentNode.childs[1].y);else for(b=0;b<a.length;b++)a[b].childs?alert("设备不能和业务系统对齐"):a[b].y=currentNode.y;return scene.removeAllEventListener(),!1}),b.find("a").unbind("click").on("click",function(){var a=$(this).text();if("设备配置"==a)alert("demo不开放此功能");else if("删除节点"==a)scene.remove(currentNode),currentNode=null,b.hide();else if("顺时针旋转"==a)currentNode.rotate+=.5;else if("逆时针旋转"==a)currentNode.rotate-=.5;else if("锚定"==a)currentNode.dragable=!1;else if("放开"==a)currentNode.dragable=!0;else if("样式设置"==a)addNodeTextFn(currentNode);else{if("加大"==a)return currentNode.lineWidth++,!1;if("缩小"==a)return currentNode.lineWidth--,!1;if("拐角加大"==a)return currentNode.offsetGap+=10,!1;if("拐角缩小"==a)return currentNode.offsetGap-=10,!1;"性能概览"==a&&(location.href="alarm.html?ip="+currentNode.ip)}b.hide()}),b.unbind("click").on("click",function(){return b.hide(),!1}),scene.click(function(a){0==a.button&&(b.hide(),$("#picker").hide())})}function initRightButton(){var b,c,a=scene.getDisplayedElements();for(b=0;b<a.length;b++)c=a[b],void 0!=c&&(c.addEventListener("mouseup",function(a){currentNode=this,handler(a)}),c.addEventListener("mousedrag",function(){}))}function addDialogFn(a){var b,c,d,e;$("#contextmenu").hide(),$("#fullTwo,#dialogTwo").remove(),b=$('<div id="fullTwo"></div>'),c=$('<div id="dialogTwo"></div>'),d="<div id='dialog_top_title' class='dialog_top_title'>设备配置</div>",d+="<div id='closeDialogTwo'>X&nbsp;</div>","container"==a.elementType?e="<label>主&nbsp;机&nbsp;名&nbsp;:<input type='text' value='"+a.text+"' id='nodeName'/></label></br>":(e="<label>主&nbsp;机&nbsp;名&nbsp;:<input type='text' value='"+a.text+"' id='nodeName' /></label></br>",e+="<label>设&nbsp;备&nbsp;I&nbsp;P:<select id='nodeIp'></select></label></br>",e+="<label>设备信息:<input type='text' value='"+a.info+"' id='nodeInfo' readonly='readonly'/></label></br>",e+="<label>地理位置:<input type='text' value='"+a.geographic+"' id='nodeGeographic' readonly='readonly'/></label></br>",e+="<label>厂&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;商:<input type='text' value='"+a.firm+"' id='nodeFirm' readonly='readonly'/></label></br>",e+="<label>代理端口:<input type='text' value='"+a.port+"' id='nodePort' readonly='readonly'/></label></br>",e+="<label>代理用户:<input type='text' value='"+a.userName+"' id='nodeUserName' readonly='readonly'/></label></br>",e+="<label>代理密码:<input type='text' value='"+a.passWord+"' id='nodePassWord' readonly='readonly'/></label></br>"),e+="<input type='button' value='确定' id='confirmTwo'/><input type='button' value='取消' id='cancelTwo'/>",c.append(d,e),$("body").append(b,c),$("#confirmTwo").on("click",function(){a.text=$("#nodeName").val(),a.ip=$("#nodeIp").find("option:selected").val(),a.info=$("#nodeInfo").val(),a.geographic=$("#nodeGeographic").val(),a.firm=$("#nodeFirm").val(),a.port=$("#nodePort").val(),a.userName=$("#nodeUserName").val(),a.passWord=$("#nodePassWord").val(),$("#fullTwo,#dialogTwo,#pickerTwo").remove(),$("#contextmenu").hide()}),""==a.ip?(getDeviceIpAjax(a),$("#nodeName").val(a.text),$("#nodeIp").val(a.ip),$("#nodeInfo").val(a.info),$("#nodeGeographic").val(a.geographic),$("#nodeFirm").val(a.firm),$("#nodePort").val(a.port),$("#nodeUserName").val(a.userName),$("#nodePassWord").val(a.passWord)):getDeviceIpAjax(a),$("#cancelTwo").on("click",function(){$("#fullTwo,#dialogTwo,#pickerTwo").remove(),$("#contextmenu").hide()}),$("#closeDialogTwo").on("click",function(){$("#fullTwo,#dialogTwo,#pickerTwo").remove(),$("#contextmenu").hide()}),dragDom("dialog_top_title","dialogTwo")}function addNodeTextFn(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for($("#contextmenu").hide(),$("#fullThree,#dialogThree").remove(),b=["下面居中","上面居中","右上偏移","左中偏移","居中显示","右中偏移","左下偏移","左上偏移","右下偏移"],c=["70","65","60","52","46","40","36","32","28","24","22","20","19","18","17","16","15","14","13","12","11","10","9","8","7","6","5","4","3","2","1","0"],d=$('<div id="fullThree"></div>'),e=$('<div id="dialogThree"></div>'),f="<div id='dialog_top_title_three' class='dialog_top_title'>文本配置</div>",f+="<div id='closeDialogThree'>X&nbsp;</div>",g="<span>&nbsp;文本位置：</span>",h=$("<select id='nodeTextPs'></select></br>"),i=0;i<b.length;i++)j="<option>"+b[i]+"</option>",h.append(j);for(k="<label class='textLabel'>&nbsp;程序位置：</label><input type='text' id='textPosition' disabled='disabled' value='"+a.textPosition+"'/></br>",l="<label>&nbsp;文本偏移：<input type='text' id='fontOffset' value='"+a.textOffsetY+"'/></label></br>",l+="<label>&nbsp;字体颜色：<input type='text' id='fontColor' value='"+a.fontColor+"'/></label></br>",l+="<label>&nbsp;背景颜色：<input type='text' id='backColor' value='"+a.fillColor+"'/></label></br>",l+="<label>&nbsp;边框颜色：<input type='text' id='borderColor' value='"+a.borderColor+"'/></label></br>",m="<span>&nbsp;边框大小：</span>",n=$("<select id='bdSizeSlc'></select></br>"),i=0;i<c.length;i++)o="<option>"+c[i]+"</option>",n.append(o);for(p="<span>&nbsp;文本大小：</span>",q=$("<select id='fontSizeSlc'></select></br>"),i=0;i<c.length;i++)r="<option>"+c[i]+"</option>",q.append(r);switch(s="<input type='button' value='确定' id='confirmThree'/><input type='button' value='取消' id='cancelThree'/>",e.append(f,g,h,k,p,q,l,m,n,s),$("body").append(d,e),selectColr("backColor"),selectColr("fontColor"),selectColr("borderColor"),a.textPosition){case"Top_Left":$("#nodeTextPs").val("左上偏移");break;case"Top_Center":$("#nodeTextPs").val("上面居中");break;case"Top_Right":$("#nodeTextPs").val("右上偏移");break;case"Middle_Left":$("#nodeTextPs").val("左中偏移");break;case"Middle_Center":$("#nodeTextPs").val("居中显示");break;case"Middle_Right":$("#nodeTextPs").val("右中偏移");break;case"Bottom_Left":$("#nodeTextPs").val("左下偏移");break;case"Bottom_Center":$("#nodeTextPs").val("下面居中");break;case"Bottom_Right":$("#nodeTextPs").val("右下偏移")}c=a.font.substr(0,2),$("#fontSizeSlc").val(c),$("#bdSizeSlc").val(a.borderWidth),$("#confirmThree").on("click",function(){a.font=$("#fontSizeSlc").val()+"px Microsoft YaHei",a.textPosition=$("#textPosition").val(),a.textOffsetY=parseInt($("#fontOffset").val()),a.fontColor=$("#fontColor").val(),a.fillColor=$("#backColor").val(),a.borderWidth=parseInt($("#bdSizeSlc").val()),"link"==a.elementType?a.strokeColor=$("#borderColor").val():a.borderColor=$("#borderColor").val(),$("#fullThree,#dialogThree,#pickerTwo").remove(),$("#contextmenu").hide()}),$("#cancelThree").on("click",function(){$("#fullThree,#dialogThree").remove(),$("#contextmenu").hide()}),$("#closeDialogThree").on("click",function(){$("#fullThree,#dialogThree").remove(),$("#contextmenu").hide()}),$("#nodeTextPs").on("change",function(){var a=$(this).val();switch(a){case"左上偏移":$("#textPosition").val("Top_Left");break;case"上面居中":$("#textPosition").val("Top_Center");break;case"右上偏移":$("#textPosition").val("Top_Right");break;case"左中偏移":$("#textPosition").val("Middle_Left");break;case"居中显示":$("#textPosition").val("Middle_Center");break;case"右中偏移":$("#textPosition").val("Middle_Right");break;case"左下偏移":$("#textPosition").val("Bottom_Left");break;case"下面居中":$("#textPosition").val("Bottom_Center");break;case"右下偏移":$("#textPosition").val("Bottom_Right")}}),dragDom("dialog_top_title_three","dialogThree")}function selectColr(a){$("#"+a).unbind("click").on("click",function(){var d,e,f,b=$("<div id='pickerTwo'><div>");return $("body").append(b),$("#pickerTwo").farbtastic("#"+a),$("#pickerTwo").is(":hidden")?($("#pickerTwo").width(),d=$("#pickerTwo").height(),$("#pickerTwo").css({top:$(this).offset().top-d,left:$(this).offset().left}).show()):(e=$("#"+a).val(),f=e.colorRgb(),$("#"+a).val(f),$("#pickerTwo").remove()),$("#pickerTwo").on("mouseleave",function(){var b=$("#"+a).val(),c=b.colorRgb();$("#"+a).val(c),$("#pickerTwo").remove()}),!1})}function showJTopoToobar(a,b,c){$(".jtopo_toolbar").remove();var d=$('<div class="jtopo_toolbar">').html('<div id="r0" class="modeRadio" title="取消任务" name="normal"></div><div id="r1" class="modeRadio" title="框选模式" name="select"></div><div id="r2" class="modeRadio" title="编辑模式" name="edit"></div><div id="r3" class="modeRadio" title="缩放模式" name="zoom"></div><div id="r4" class="modeRadio" title="居中对齐" name="centent"></div><div id="showModel" title="模型库"></div><div id="showFunc" title="更多"></div>');$("#"+c).before(d),$("#showModel").hide().on("click",function(){var a=$("#modelDialog");a.is(":hidden")?a.animate({height:"80%",opacity:1,top:"10%"},1e3).show():a.animate({height:0,opacity:.1,top:"10%"},1e3,function(){$(this).hide()})}),$("#showFunc").hide().on("click",function(){var a=$("#operateDialog");a.is(":hidden")?a.animate({height:"80%",opacity:1,top:"10%"},1e3).show():a.animate({height:0,opacity:.1,top:"10%"},1e3,function(){$(this).hide()})}),$(".jtopo_toolbar .modeRadio").on("click",function(){a.wheelZoom=null,"zoom"==$(this).attr("name")?a.wheelZoom=.8:"centent"==$(this).attr("name")?a.centerAndZoom():a.mode=$(this).attr("name")})}function navEvent(){$("#navControl").click(function(){var a=$(this),b=$("#nav");"navHide"==b.attr("class")?(b.css("display","block"),b.animate({height:"70px"},500,function(){autoAdaptation("canvas")}),b.removeClass("navHide"),a.removeClass("navClickHide")):(b.animate({height:"0px"},500,function(){b.css("display","none"),autoAdaptation("canvas")}),b.addClass("navHide"),a.addClass("navClickHide"))})}function autoAdaptation(a){var b=$("#main"),c=$("header"),d=document.getElementById(a);b.width($(window).width()).height($(window).height()-c.height()),d.width=c.width(),d.height=b.height(),$("#navControl").css({left:$("#nav").width()/2}),$(window).resize(function(){b.width($(window).width()).height($(window).height()-c.height()),d.width=c.width(),d.height=b.height(),$("#navControl").css({left:$("#nav").width()/2})})}function addGetDialogFn(a){var b,c,d,e,f,g,h,i,j;$("#dialogGet,#fullGet").remove(),b=$('<div id="fullGet"></div>'),c=$('<div id="dialogGet"></div>'),d="<div id='dialogTitleGet' class='dialogTitleGet'>拓扑配置</div>",d+="<div id='closeDialogGet'>X&nbsp;</div>",e=$("<div id='contenDiv'></div>"),f=$("<div id='topoFn'></div>"),g=$("<div id='newSaveTopo' title='新建'></div>"),h=$("<div id='updeteTopo' title='刷新'></div>"),i=$("<div id='deleteTopo' title='删除已选'></div>"),f.append(g,h,i),j=newButtomTable(a),e.append(f,j),c.append(d,e),$("body").append(b,c),dragDom("dialogTitleGet","dialogGet"),$("#buttomTbody table tr:nth-child(odd)").addClass("altow"),$("#closeDialogGet").on("click",function(){$("#dialogGet,#fullGet").remove()}),$("#newSaveTopo").on("click",function(){$("#dialogGet,#fullGet").remove(),scene.clear(),getModelAjax(),addJtopoMenu(),$("#showModel,#showFunc").show()}),$("#updeteTopo").on("click",function(){topoTableAjax()}),$("#deleteTopo").on("click",function(){alert("未添加功能!")}),$("#buttomTbody table tr td div").on("click",function(){"删除"==$(this).attr("title")?(deleteTopoAjax($(this).attr("data_id")),$(this).parent().parent("tr").remove()):updeteTopoAjax($(this).attr("data_id"))})}function newButtomTable(a){var f,g,h,i,j,k,b=$("<div id='tableFn'></div>"),c=$("<div id='buttomTable'></div>"),d=$("<table></table>"),e=$("<tr><td style='min-width:50px;max-width:50px;'><input type='checkbox' id='chk_all'/></td><td style='min-width:220px;max-width:220px;'>名称</td><td style='min-width:220px;max-width:220px;'>操作</td><td style='min-width:18px;'></td></tr>");for(d.append(e),c.append(d),f=$("<div id='buttomTbody'></div>"),g=$("<table></table>"),h=0;h<a.length;h++)e=$("<tr></tr>"),i="<td style='min-width:50px;max-width:50px;'><input type='checkbox' name='chk_list'/></td>",i+="<td style='min-width:220px;max-width:220px;' >"+a[h].name+"</td>",i+="<td style='min-width:220px;max-width:220px;'><div data_name='"+a[h].name+"' data_id='"+a[h].id+"' class='tableUpdete'></div><div data_id='"+a[h].id+"' class='tableDetele' title='删除'></div></td>",e.append(i),g.append(e);if(a.length<12)for(j=12-a.length,k=0;j>k;k++)e=$("<tr></tr>"),i="<td style='min-width:50px;'></td>",i+="<td style='min-width:220px;' ></td>",i+="<td style='min-width:220px;'></td>",e.append(i),g.append(e);return f.append(g),b.append(c,f),b}function dragDom(a,b){var c=$("#"+a),d=$("#"+b);c.bind("mousedown",function(){d.css({opacity:.4}),$(document).mousemove(function(a){d.css({left:a.clientX-c.width()/2,top:a.clientY-c.height()/2}),$("body").css({overflow:"hidden"})}),$(document).mouseup(function(){d.css({opacity:1}),$(document).unbind("mousemove"),$(document).unbind("mouseup")})})}function topoSelectAjax(){$.ajax({async:!1,cache:!1,type:"GET",dataType:"json",url:"js/jsonData/topoSelect.json",error:function(){alert("拓扑名称查询失败")},success:function(a){$("#nav").addTopoNameOption(a)}})}function getTopoAjax(a,b){$.ajax({async:!1,cache:!1,type:"GET",dataType:"json",url:"js/jsonData/topo.json",error:function(){alert("业务系统查询失败")},success:function(a){"查询"==b?$.topo.newScene(scene,a):"初始化"==b&&$.topo.newCanvas("canvas",a),initRightButton()}})}function deleteTopoAjax(a){$.ajax({async:!1,cache:!1,type:"GET",dataType:"json",url:"js/jsonData/topoSelect.json",error:function(){alert("拓扑名称查询失败")},success:function(){alert("id为"+a+"删除成功"),initRightButton()}})}function updeteTopoAjax(){$.ajax({async:!1,cache:!1,type:"GET",dataType:"json",url:"js/jsonData/topo.json",error:function(){alert("拓扑名称查询失败")},success:function(a){$("#closeDialogGet").click(),$.topo.newScene(scene,a),initRightButton()}})}function topoTableAjax(){$.ajax({async:!1,cache:!1,type:"GET",dataType:"json",url:"js/jsonData/topoSelect.json",error:function(){alert("拓扑名称查询失败")},success:function(a){addGetDialogFn(a)}})}function getModelAjax(){$.ajax({async:!1,cache:!1,type:"GET",dataType:"json",url:"js/jsonData/model.json",error:function(){alert("拓扑名称查询失败")},success:function(a){addModel(a)}})}function getDeviceIpAjax(a){$.ajax({async:!0,cache:!1,type:"GET",dataType:"json",url:"js/jsonData/ipSelect.json",error:function(){alert("设备IP查询失败")},success:function(b){var c,d;if(console.log(JSON.stringify(b)),"null"==b||null==b)return alert("请添加设备!"),!1;for(c=0;c<b.length;c++)d=$("<option value='"+b[c].ip+"' data-index='"+c+"'>"+b[c].ip+"</option>"),$("#nodeIp").append(d);a.ip?$("#nodeIp").val(a.ip):($("#nodeIp").val(b[0].ip),$("#nodeName").val(b[0].host_name),$("#nodeInfo").val(b[0].isCollect),$("#nodeGeographic").val(b[0].location),$("#nodeFirm").val(b[0].id),$("#nodePort").val(b[0].patrol_port),$("#nodeUserName").val(b[0].patrol_username),$("#nodePassWord").val(b[0].patrol_password)),$("#nodeIp").on("change",function(){var a=$(this).find("option:selected").data("index");$("#nodeName").val(b[a].host_name),$("#nodeInfo").val(b[a].isCollect),$("#nodeGeographic").val(b[a].location),$("#nodeFirm").val(b[a].id),$("#nodePort").val(b[a].patrol_port),$("#nodeUserName").val(b[a].patrol_username),$("#nodePassWord").val(b[a].patrol_password)})}})}var scene,stage,topoReg,runPrefixMethod,line=null,fNode=null,currentNode=null,tempNode=new JTopo.Node("temp");tempNode.setSize(1,1),topoReg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,String.prototype.colorRgb=function(){var b,c,d,a=this.toLowerCase();if(a&&topoReg.test(a)){if(4===a.length){for(b="#",c=1;4>c;c+=1)b+=a.slice(c,c+1).concat(a.slice(c,c+1));a=b}for(d=[],c=1;7>c;c+=2)d.push(parseInt("0x"+a.slice(c,c+2)));return d.join(",")}return a},jQuery.topo={newCanvas:function(a,b){var e,c=$("#main"),d='<canvas id="'+a+'" width="800" height="510"></canvas>';c.html("").append(d),e=document.getElementById(a),stage=new JTopo.Stage(e),scene=new JTopo.Scene(stage),scene.background="image/bg.png",stage.add(scene),b&&$.topo.newScene(scene,b),autoAdaptation(a),showJTopoToobar(stage,scene,a)},newScene:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(a.clear(),c=0;c<b.node.length;c++)d=$.topo.newNode(b.node[c],"image/nodeImg/"),a.add(d);if(b.link)for(c=0;c<b.link.length;c++)e=b.link[c],f=a.find('node[mapId="'+e.fromNodeMapId+'"]'),d=f[0],g=a.find('node[mapId="'+e.toNodeMapId+'"]'),h=g[0],i=$.topo.newLink(d,h,e),a.add(i);if(b.container)for(c=0;c<b.container.length;c++){for(j=b.container[c],k=$.topo.newContainer(j),l=0;2>l;l++)m=new JTopo.Node,m.textPosition="Middle_Center",m.setBound(k.x+200*l,k.y+200*l,10,10),m.zIndex=13,m.visible=!1,a.add(m),k.add(m);for(a.add(k),n=0;n<j.childs.length;n++)o=a.find('node[mapId="'+j.childs[n]+'"]'),p=o[0],k.add(p)}},newNode:function(a,b){var c=new JTopo.Node;return c.topoId=a.topoId,c.id=a.id,c.mapId=a.mapId,c.setLocation(parseInt(a.x),parseInt(a.y)),c.setSize(parseInt(a.width),parseInt(a.height)),c.zIndex=parseInt(a.zIndex),c.borderWidth=parseInt(a.borderWidth),c.borderRadius=parseInt(a.borderRadius),c.textOffsetY=parseFloat(a.textOffsetY),c.textOffsetX=parseFloat(a.textOffsetX),c.alpha=parseFloat(a.alpha),c.text=a.text,c.font=a.font,c.fontColor=a.fontColor,c.setImage(b+a.nodeImg,!1),c.textPosition=a.textPosition,c.borderColor=a.borderColor,c.fillColor=a.fillColor,c.alarmVlaue=a.alarmVlaue,c.dragable="true"==a.dragable?!0:!1,c.ip=a.ip,c.info=a.info,c.geographic=a.geographic,c.firm=a.firm,c.agent=a.agent,c.port=a.port,c.userName=a.userName,c.passWord=a.passWord,c},newContainer:function(a){var b=new JTopo.Container;return b.topoId=a.topoId,b.id=a.id,b.setLocation(parseInt(a.x),parseInt(a.y)),b.textOffsetY=parseFloat(a.textOffsetY),b.textOffsetX=parseFloat(a.textOffsetX),b.zIndex=parseInt(a.zIndex),b.borderWidth=parseInt(a.borderWidth),b.borderRadius=parseInt(a.borderRadius),b.alpha=parseFloat(a.alpha),b.text=a.text,b.font=a.font,b.fontColor=a.fontColor,b.borderColor=a.borderColor,b.fillColor=a.fillColor,b.textPosition=a.textPosition,b.childNodes=a.childs,b.dragable="true"==a.dragable?!0:!1,b},newLink:function(a,b,c){if("link"==c.nodeType){var d;return"直线"==c.linkClass?d=new JTopo.Link(a,b):"虚直线"==c.linkClass?(d=new JTopo.Link(a,b),d.dashedPattern=c.dashedPattern):"直线带箭头"==c.linkClass?(d=new JTopo.Link(a,b),d.arrowsRadius=c.arrowsRadius):"虚直线箭头"==c.linkClass?(d=new JTopo.Link(a,b),d.dashedPattern=c.dashedPattern,d.arrowsRadius=c.arrowsRadius):"折线"==c.linkClass?d=new JTopo.FoldLink(a,b):"虚折线"==c.linkClass?(d=new JTopo.FoldLink(a,b),d.dashedPattern=c.dashedPattern):"折线带箭头"==c.linkClass?(d=new JTopo.FoldLink(a,b),d.arrowsRadius=c.arrowsRadius):"虚折线箭头"==c.linkClass?(d=new JTopo.FoldLink(a,b),d.dashedPattern=c.dashedPattern,d.arrowsRadius=c.arrowsRadius):"二次折线"==c.linkClass?d=new JTopo.FlexionalLink(a,b):"虚二次折线"==c.linkClass?(d=new JTopo.FlexionalLink(a,b),d.dashedPattern=c.dashedPattern):"二次折线带箭头"==c.linkClass?(d=new JTopo.FlexionalLink(a,b),d.arrowsRadius=c.arrowsRadius):"虚二次折线箭头"==c.linkClass?(d=new JTopo.FlexionalLink(a,b),d.dashedPattern=c.dashedPattern,d.arrowsRadius=c.arrowsRadius):"曲线"==c.linkClass&&(d=new JTopo.CurveLink(a,b),d.dashedPattern=c.dashedPattern,d.arrowsRadius=c.arrowsRadius),d.bundleOffset=parseFloat(c.bundleOffset),d.zIndex=parseFloat(c.zIndex),d.lineWidth=parseFloat(c.lineWidth),d.bundleGap=parseFloat(c.bundleGap),d.offsetGap=parseFloat(c.offsetGap),d.textOffsetY=parseFloat(c.textOffsetY),d.textOffsetX=parseFloat(c.textOffsetX),d.alpha=parseFloat(c.alpha),d.font=c.font,d.text=c.text,d.fontColor=c.fontColor,d.linkClass=c.linkClass,d.strokeColor=c.strokeColor,d.alarmValue=c.alarmValue,d.fromNodeMapId=c.fromNodeName,d.fromNodeIp=c.fromNodeIp,d.toNodeMapId=c.toNodeName,d.toNodeIp=c.toNodeIp,d.ip=c.ip,d.info=c.info,d.geographic=c.geographic,d.firm=c.firm,d.agent=c.agent,d.port=c.port,d.userName=c.userName,d.passWord=c.passWord,d}}},runPrefixMethod=function(a,b){var c;return["webkit","moz","ms","o",""].forEach(function(d){if(!c){""===d&&(b=b.slice(0,1).toLowerCase()+b.slice(1));var e=typeof a[d+b];"undefined"!=e+""&&(c="function"===e?a[d+b]():a[d+b])}}),c},function(a){a.fn.addTopoNameOption=function(b){var d,e,f,g,h,i,c=a('<select id="nav_select"></select>');for(d=0;d<b.length;d++)e='<option data_id="'+b[d].id+'">'+b[d].name+"</option>",c.append(e);f=a("<div title='刷新' class='nav_img' id='updeteDiv'></div>"),g=a("<div id='fullMax' class='nav_img' title='全屏'></div>"),h=a("<div id='deploy' class='nav_img' title='设置'></div>"),a("#nav").html("").append(c,g,h,f),a("#deploy").on("click",function(){topoTableAjax()
}),a("#updeteDiv").on("click",function(){i=a("#nav_select").find("option:selected"),getTopoAjax(i,"查询")}),a("#fullMax").on("click",function(){runPrefixMethod(stage.canvas,"RequestFullScreen")}),a("#nav_select").on("change",function(){a("#showFunc,#showModel").hide(),a("#modelDialog,#operateDialog").remove(),i=a("#nav_select").find("option:selected"),scene&&getTopoAjax(i,"查询")}),i=a("#nav_select").find("option:selected"),getTopoAjax(i,"初始化")}}(jQuery);