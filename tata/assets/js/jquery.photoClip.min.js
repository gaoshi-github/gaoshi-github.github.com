!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["jquery","hammer","iscroll"],b):"object"==typeof exports?module.exports=b(require("jquery"),require("hammer"),require("iscroll")):b(a.jQuery)}(this,function(a,b,c){"use strict";function d(d,g){function M(){w=!0,A.append(this),Z.call(this,t,function(){u=this.naturalWidth,v=this.naturalHeight}),Z(z,function(){O()}),p.call(this,this.src)}function N(){var a={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};D=new c(y[0],a)}function O(){J=0,K=0,L=0,A.css({width:u,height:v}),db(A,J,K,L),ab(u,v),D.zoom(D.options.zoomStart),P(u,v);var a=.5*(h-u*D.options.zoomStart),b=.5*(i-v*D.options.zoomStart);D.scrollTo(a,b)}function P(a,b){z.css({width:a,height:b}),y.append(z),D.refresh()}function Q(){var c,d,e,a=!!navigator.userAgent.match(/mobile/i);a?(c=new b(z[0]),c.add(new b.Rotate),c.on("rotatemove",function(a){I||(d=a.rotation,d>180?d-=360:-180>d&&(d+=360),e=d>0?1:0>d?-1:0)}),c.on("rotateend",function(a){I||Math.abs(d)>30&&(1==e?R(a.center):-1==e&&S(a.center))})):z.on("dblclick",function(a){R({x:a.clientX,y:a.clientY})})}function R(a){T(90,a)}function S(a){T(-90,a)}function T(a,b){var c,n,o,d,e,f,g,j,k,l,m;I||(I=!0,c=b?Y(z,b.x,b.y):X(z,y,.5*h,.5*i),d=$(L,c),e=d.x,f=d.y,g=0,j=0,k=0,l=0,m=L+a,90==m||-270==m?(g=e+f,j=f-e,m>L?(k=v-e-f,l=e-f):L>m&&(k=v-f-(u-e),l=e+f-v),n=v,o=u):180==m||-180==m?(g=2*e,j=2*f,m>L?(k=u-e-(v-f),l=v-(e+f)):L>m&&(k=u-(e+f),l=v-f-(u-e)),n=u,o=v):270==m||-90==m?(g=e-f,j=e+f,m>L?(k=e+f-u,l=u-e-(v-f)):L>m&&(k=f-e,l=u-e-f),n=v,o=u):(0==m||360==m||-360==m)&&(g=0,j=0,m>L?(k=e-f,l=e+f-u):L>m&&(k=e+f-v,l=f-e),n=u,o=v),0==L?(J=0,K=0):90==L||-270==L?(J-=e+f,K-=f-e):180==L||-180==L?(J-=2*e,K-=2*f):(270==L||-90==L)&&(J-=e-f,K-=e+f),J=J.toFixed(2)-0,K=K.toFixed(2)-0,db(A,J,K,L,e,f),eb(A,J,K,m,200,function(){I=!1,L=m%360,J+=g+k,K+=j+l,J=J.toFixed(2)-0,K=K.toFixed(2)-0,db(A,J,K,L),D.scrollTo(D.x-k*D.scale,D.y-l*D.scale),ab(n,o),D.scale<D.options.zoomMin&&D.zoom(D.options.zoomMin),P(n,o)}))}function U(){C=document.createElement("canvas"),C.width=h,C.height=i}function V(){var a,b,c,d;w&&(a=X(z,y),b=D.scale,c=C.getContext("2d"),c.clearRect(0,0,C.width,C.height),c.save(),n?c.scale(b,b):(C.width=h/b,C.height=i/b),c.translate(J-a.x/b,K-a.y/b),c.rotate(L*Math.PI/180),c.drawImage(t[0],0,0),c.restore(),d=C.toDataURL(m,1),B.attr("src",d),r.call(t[0],d))}function W(){Z(x,function(){E=x.width(),F=x.height()})}function X(a,b,c,d){c=c||0,d=d||0;var e,f;return Z(a,function(){e=a.offset()}),Z(b,function(){f=b.offset()}),{x:f.left-e.left+c,y:f.top-e.top+d}}function Y(a,b,c){b=b||0,c=c||0;var d;return Z(a,function(){d=a.offset()}),{x:b+H.scrollLeft()-d.left,y:c+H.scrollTop()-d.top}}function Z(b,c){var d=a();a.each(b,function(b,c){var g,e=a(c),f=e.parents().andSelf().filter(":hidden");for(b=0;b<f.length&&e.is(":hidden");b++)g=f.eq(b),"none"==g.css("display")&&(d=d.add(g.show()))}),"function"==typeof c&&c.call(this),d.hide()}function $(a,b){var c=D.scale,d={};return 0==a?(d.x=b.x/c,d.y=b.y/c):90==a||-270==a?(d.x=b.y/c,d.y=v-b.x/c):180==a||-180==a?(d.x=u-b.x/c,d.y=v-b.y/c):(270==a||-90==a)&&(d.x=u-b.y/c,d.y=b.x/c),d}function _(a,b,c,d){var e=a/c,f=b/d;return e>f?e:f}function ab(a,b){D.options.zoomMin=_(h,i,a,b),D.options.zoomMax=Math.max(1,D.options.zoomMin),D.options.zoomStart=Math.min(D.options.zoomMax,_(E,F,a,b))}function bb(a,b,c,d){var e,f,g,h,i,j,k,l;return b=b||.8,c=c||0,e=d||"image/jpeg",f=a.naturalWidth,g=a.naturalHeight,h=Math.max(f,g),h>1024&&(i=Math.min(f,g),i=1024*(i/h),h=1024,f>g?(f=h,g=i):(f=i,g=h)),j=document.createElement("canvas"),k=j.getContext("2d"),c?(j.width=g,j.height=f,k.translate(g,0),k.rotate(c*Math.PI/180)):(j.width=f,j.height=g),k.drawImage(a,0,0,f,g),l=j.toDataURL(e,b||.8)}function cb(b){t&&t.length&&(t.remove(),delete t[0]),t=a("<img>").css({"user-select":"none","pointer-events":"none"}),t.load(M),t.attr("src",b)}function db(a,b,c,d,f,g){f=f||0,g=g||0;var h={};h[e+"transform"]="translateZ(0) translate("+b+"px,"+c+"px) rotate("+d+"deg)",h[e+"transform-origin"]=f+"px "+g+"px",a.css(h)}function eb(a,b,c,d,g,h){a.css(e+"transform"),a.css(e+"transition",e+"transform "+g+"ms"),a.one(f,function(){a.css(e+"transition",""),h.call(this)}),a.css(e+"transform","translateZ(0) translate("+b+"px,"+c+"px) rotate("+d+"deg)")}function fb(){x=a(d).css({"user-select":"none",overflow:"hidden"}),"static"==x.css("position")&&x.css("position","relative"),y=a("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:h,height:i,"margin-left":-h/2,"margin-top":-i/2}).appendTo(x),z=a("<div class='photo-clip-moveLayer'>").appendTo(y),A=a("<div class='photo-clip-rotateLayer'>").appendTo(z);var b=a("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(x);a("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:i,"margin-right":h/2,"margin-top":-i/2,"margin-bottom":-i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":h/2,"margin-top":-i/2,"margin-bottom":-i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":i/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(b),a("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:h,height:i,"margin-left":-h/2-1,"margin-top":-i/2-1}).appendTo(b),B=a(k)}var s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,h=g.width,i=g.height,j=g.file,k=g.view,l=g.ok,m=g.outputType||"image/jpeg",n=g.strictSize,o=g.loadStart,p=g.loadComplete,q=g.loadError,r=g.clipFinish;"jpg"===m?m="image/jpeg":"png"===m&&(m="image/png"),s=a(j),s.length&&(s.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var b=new FileReader;b.onprogress=function(a){console.log((100*(a.loaded/a.total)).toFixed()+"%")},b.onload=function(b){var d,e,c=b.total/1024;c>1024?(d=1024/c,e=a("<img>").hide(),e.load(function(){var b,c,f,a=this.naturalWidth;e.appendTo(document.body),b=this.naturalHeight,e.remove(),delete e[0],e=null,c=0,a==b&&(c=90),f=bb(this,d,c,m),cb(f)}),e.attr("src",this.result)):cb(this.result)},b.onerror=function(a){alert("图片加载失败"),q.call(this,a)},b.readAsDataURL(this.files[0]),o.call(b,this.files[0])}}),s.click(function(){this.value=""}),fb(),N(),Q(),U(),G=a(l),G.length&&G.click(function(){V()}),H=a(window),W(),H.resize(W))}a.fn.photoClip=function(b){if(!window.FileReader)return alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！"),void 0;var c={width:200,height:200,file:"",view:"",ok:"",outputType:"jpg",strictSize:!1,loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return a.extend(c,b),this.each(function(){d(this,c)}),this};var f,e="";return function(){var a,g,b={Webkit:"webkit",Moz:"",O:"o"},c=document.documentElement,d=function(b){return a?a+b:b.toLowerCase()};for(g in b)if(void 0!==c.style[g+"TransitionProperty"]){e="-"+g.toLowerCase()+"-",a=b[g];break}f=d("TransitionEnd")}(),a});

